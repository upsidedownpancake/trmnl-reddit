name: Update TRMNL

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Reddit and Push to TRMNL
        run: |
          # 1. Get a Guest Token from Reddit
          # This makes you look like a real 'logged-out' app user
          GUEST_TOKEN=$(curl -s -X POST "https://www.reddit.com/api/v1/access_token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=https://oauth.reddit.com/grants/installed_client&device_id=DO_NOT_TRACK_THIS_DEVICE" \
            | jq -r '.access_token')

          # 2. Fetch the actual data using that token
          RESPONSE=$(curl -sL -H "Authorization: Bearer $GUEST_TOKEN" \
            -A "TRMNL-Plugin-Bot/1.0" \
            'https://oauth.reddit.com/r/gonewild/hot.json?limit=5')

          # 3. Process into TRMNL format
          # This checks for i.redd.it links and puts them in merge_variables
          PAYLOAD=$(echo "$RESPONSE" | jq -c '{
            merge_variables: {
              images: [
                .data.children[].data 
                | select(.url != null and (.url | contains("i.redd.it"))) 
                | {url: .url, title: .title}
              ]
            }
          }')

          # 4. Debug and Send
          echo "Payload generated. Sending to TRMNL..."
          curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
