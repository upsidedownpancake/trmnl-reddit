- name: Fetch Reddit and Push to TRMNL
        run: |
          # 1. Fetch data
          RESPONSE=$(curl -sL -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            'https://old.reddit.com/r/gonewild.json?limit=5')

          # 2. DEBUG: Show us what we actually got
          echo "First 100 chars of response:"
          echo "$RESPONSE" | head -c 100
          echo -e "\n---"

          # 3. Try to parse only if it looks like JSON
          if [[ "$RESPONSE" == {* ]]; then
            PAYLOAD=$(echo "$RESPONSE" | jq -c '{
              merge_variables: {
                images: [
                  .data.children[].data 
                  | select(.url != null and (.url | test("i\\.redd\\.it.*\\.(jpe?g|png)$"))) 
                  | {url: .url, title: .title}
                ]
              }
            }')
            
            echo "Sending to TRMNL..."
            curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
          else
            echo "CRITICAL ERROR: Reddit did not return JSON. It returned the HTML shown above."
            exit 1
          fi
