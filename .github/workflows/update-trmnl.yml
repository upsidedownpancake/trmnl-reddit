name: Update TRMNL

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Reddit and Push to TRMNL
        run: |
          # 1. Fetch from old.reddit (better for guest access)
          # We use a real-looking User-Agent to prevent the 429 error
          RAW_JSON=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            'https://old.reddit.com/r/gonewild.json?limit=5')

          # 2. Check if we actually got data (length of children array)
          DATA_COUNT=$(echo "$RAW_JSON" | jq '.data.children | length')

          if [ "$DATA_COUNT" -eq 0 ] || [ "$DATA_COUNT" == "null" ]; then
            echo "Error: Reddit returned no data. They might be blocking this request."
            exit 1
          fi

          # 3. Process into TRMNL format
          PAYLOAD=$(echo "$RAW_JSON" | jq -c '{
            merge_variables: {
              images: [
                .data.children[].data 
                | select(.url != null and (.url | test("i\\.redd\\.it.*\\.(jpe?g|png)$"))) 
                | {url: .url, title: .title}
              ]
            }
          }')

          # 4. Send to TRMNL
          echo "Sending to TRMNL..."
          curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
