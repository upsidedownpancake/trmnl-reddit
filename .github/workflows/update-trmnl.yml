name: Update TRMNL

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch via Proxy
        run: |
          # Use a public RSSHub instance to turn the sub into a clean JSON feed
          # This handles the 'Blocked' error for us.
          RESPONSE=$(curl -sL "https://rsshub.app/reddit/subreddit/gonewild.json")

          # We use a very 'safe' jq filter that won't error out if fields are missing
          PAYLOAD=$(echo "$RESPONSE" | jq -c '{
            merge_variables: {
              images: [
                .items[]? | {
                  url: (.content_html | capture("src=\"(?<u ripple>[^\"]+i\\.redd\\.it[^\"]+)\"") | .u),
                  title: .title
                }
              ] | [select(.url != null)] | .[:5]
            }
          }')

          if [[ "$PAYLOAD" == *'"images":[]'* ]]; then
            echo "Warning: No images found, but the connection worked."
          fi

          curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
