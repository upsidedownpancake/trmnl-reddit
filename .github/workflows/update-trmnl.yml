name: Update TRMNL

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Reddit RSS and Push to TRMNL
        run: |
          # Try RSS feed which sometimes bypasses restrictions
          curl -A "Mozilla/5.0" -s 'https://www.reddit.com/r/gonewild/.rss' | \
          grep -oP '(?<=<media:content url=")[^"]*' | \
          grep -E '\.(jpg|jpeg|png)$' | \
          head -10 | \
          jq -R -s 'split("\n") | map(select(length > 0)) | map({url: ., title: "Reddit"}) | {merge_variables: {images: .}}' | \
          curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d @-
