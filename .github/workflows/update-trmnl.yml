name: Update TRMNL

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Reddit and Push to TRMNL
        run: |
          REDDIT_DATA=$(curl -s 'https://www.reddit.com/r/gonewild.json')
          IMAGES=$(echo "$REDDIT_DATA" | jq '{images: [.data.children[].data | select(.url | contains("i.redd.it")) | select(.url | test("\\.(jpg|jpeg|png)$")) | {url: .url, title: .title}]}')
          curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"merge_variables\": $IMAGES}"
