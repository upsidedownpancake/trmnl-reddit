name: Update TRMNL

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch via Proxy and Push to TRMNL
        run: |
          # 1. Fetch from a proxy that handles the Reddit block for us
          # Note: We use the 'rsshub.app' proxy which is much friendlier to bots
          RESPONSE=$(curl -sL 'https://rsshub.app/reddit/subreddit/gonewild')

          # 2. Process the data
          # Since the proxy returns a slightly different format, we adjust the jq:
          PAYLOAD=$(echo "$RESPONSE" | jq -c '{
            merge_variables: {
              images: [
                .item[] 
                | select(.description != null) 
                | {
                    url: (.description | codepoint_at(0) | .[] | select(contains("i.redd.it"))), 
                    title: .title
                  }
              ]
            }
          }')

          # 3. Send to TRMNL
          curl -X POST "${{ secrets.TRMNL_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
